#!/bin/sh
set -ex

if test -z "$SWAYSOCK" && pidof gnome-shell > /dev/null
then
    exit 0
fi

test -z "$XDG_RUNTIME_DIR" &&
    export XDG_RUNTIME_DIR=/run/user/$(id -u)

die() {
    test "$?" = 0 ||
        notify-send "Failed to sync mail" "try unlocking your gpg key"
}
# trap die EXIT

{%@@ for name in mail | reverse @@%}
    mkdir -p "$HOME/.local/share/mail/{{@@ name @@}}/"
{%@@ endfor @@%}

getnew() {
    cd "$HOME/.local/share/mail/" >/dev/null

    find */INBOX*/new -type f |
        sed -E '/Duolingo|LBRY/d' |
        wc -l
}

OLD=$(getnew)

if test "$1" = "update" && ! pidof mbsync; then
    if ! ping -c3 {{@@ mail.personal.mail @@}} > /dev/null
    then
        exit 0
    fi
    mbsync -a
fi

NEW=$(getnew)

if test "$NEW" -gt "$OLD"; then
    notify-send "ïƒ  New E-Mails!"
fi

echo $NEW | sed 's/^0$//'

caller=$(ps -o comm= $PPID)
if test "$caller" != "waybar"; then
    pidof waybar >/dev/null &&
        pkill -SIGRTMIN+4 waybar
fi

# vim:ft=sh
